---
title: "Mental Health and its Impact on Bullying in Schools"
output: html_notebook
---
## Abstract

  While mental health has always been a factor in our education, it has only been recently that it has risen to the forefront of conversation about the impact it has on the education and school environments. In order to capture the impact mental health has on our educational systems today, we look at the mental health of several children in US high school level ages.

  We seek to understand what most commonly plagues teenagers in the mental health spectrum and what we can do to help address and alleviate this issue.

## Initial Setup
```{r}
rm(list = ls())
```

### Libraries
```{r}
library(sas7bdat)
library(tidyverse)
library(ggplot2)
library(data.table)
library(mosaic)
library(ggformula)
library(MASS)
library(dplyr)
```

### Datasets
```{r}
schooldataraw <- read.sas7bdat("C:\\Users\\julia\\OneDrive\\Desktop\\2018109\\07_FINAL PU DATA_February 5, 2018\\pu_ssocs16.sas7bdat")
studenthealthraw <- read.csv("C:\\Users\\julia\\Downloads\\DASH_-_Global_School-based_Student_Health_Survey__GSHS_.csv")
```

### Functions
```{r}
convertBoolean <- function(x) {
  return(x==1)
}
```

### Palettes
```{r}
fiveColorPalette <- c("red2", "orange", "gold", "forestgreen", "royalblue")
sevenColorPalette <- c("salmon", "orange", "gold", "forestgreen", "royalblue", "purple2", "pink1")
```

## Data Wrangling and Cleaning

### Cleaning the 2018-2019 School Survey on Crime and Safety
```{r}
#selecting and cleaning up the chosen variables
schooldata <-
  schooldataraw %>%
  dplyr::select(C0174, C0662, C0664, C0666, C0668, C0670, C0672, C0674, C0676, C0678, C0670, C0672, C0674, C0676, C0678, C0680, C0682, C0684, C0686, C0265, C0267, C0273, C0376) %>%
  transmute(id = row_number(), antiBullying = C0174,
         assessAva = 6 - (C0662 + C0664 + C0666),
         treatAva = 6 - (C0668 + C0670 + C0672),
         limitMHProfAccess = C0674, limitFunding = C0676, limitLegal = C0678, limitParental = C0680, 
         limitComm = C0682, limitPaymentPol = C0684, limitStigma = C0686,
         discCyber = C0265, discBullying = C0267, recogBullying = C0273,
         bullyingRate = C0376)
```

```{r}
booleanRows = c(1, 12, 13, 14)

boolSchoolData <-
  lapply(schooldata[,booleanRows], convertBoolean)

schooldata[ , 1  ] <- boolSchoolData[1]
schooldata[ , 12 ] <- boolSchoolData[2]
schooldata[ , 13 ] <- boolSchoolData[3]
schooldata[ , 14 ] <- boolSchoolData[4]
```

```{r}
limitations <- data.table(comm = schooldata$limitComm, 
                          funding = schooldata$limitFunding, 
                          legal = schooldata$limitLegal, 
                          MHProfAccess = schooldata$limitMHProfAccess, 
                          parental = schooldata$limitParental, 
                          paymentPol = schooldata$limitPaymentPol, 
                          stigma = schooldata$limitStigma)
```

### Cleaning the Global Student Health Survey
```{r}
studenthealth <-
  studenthealthraw %>%
  transmute(Topic, Description, Question = Greater_Risk_Question, RespPct = Greater_Risk_Data_Value, Sample_Size, Sex, Age) %>%
  filter(Topic == "Mental Health" & Sex != "Total" & 
           Age != "Total" & Age != "13-15" & Age != "13-17") %>%
  na.omit()

studenthealth <-
  studenthealth %>%
  group_by(Age, Sex, Question) %>%
  mutate(totalSS = sum(Sample_Size)) %>%
  mutate(AffRespPct = sum((Sample_Size)*(RespPct))/totalSS) %>%
  dplyr::select(Sex, Age, Question, AffRespPct, totalSS) %>% 
  unique() %>%
  arrange(Sex, Age)
```

## Codebooks

### 2018-2019 School Survey on Crime and Safety
| Variable Name | Description |
| --- | --- |
| ID | The ID number of the School, given for purposes of the study |
| antiBullying | A boolean describing whether a school has anti-bullying programs put into place. |
| assessAva | An aggregate describing whether a school has mental health services for diagnostic assessment available, with a score of 3 being the highest. |
| treatAva | An aggregate describing whether a school has mental health services for treatment available, with a score of 3 being the highest. |
| limitMHProfAccess | A score describing whether inadequate access to mental health professionals was a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitFunding | A score describing whether inadequate funding was a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitLegal | A score describing whether potential legal issues, such as malpractice, or insufficient supervision were a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitParental | A score describing whether lack of parental support was a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitComm | A score describing whether lack of community support was a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitPaymentPol | A score describing whether payment polcies were a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| limitStigma | A score describing whether concern for potential stigmatization of the student was a limiting factor in the school's efforts to provide mental health services to its students, with 1 being major limitations, and 3 being no limitations. |
| discCyber | A boolean describing whether school staff were trained in discipline policies and practices related to cyberbullying. |
| discBullying | A boolean describing whether school staff were trained in discipline policies and practices related to bullying. |
| recogBullying | A boolean describing whether school staff were trained in recognizing bullying. |
| bullyingRate | A score describing how often bullying occurs at a school, with 1 being daily and 5 being never. |

### Global Student Health Survey
| Variable Name | Description |
| --- | --- |
| Topic | A variable meant for categorizing, used to filter down to just mental health. |
| Question | A question asked related to mental health, with the relevant time frame being the 12 months before the survey |
| AffRespPct | Percent of people who responded yes to the question. |
| Sample Size | The amount of people who answered this question, with the specified sex and age. |
| Sex | The sex of the recipients. |
| Age | The age of the recipients. |

## Analysis

### How Effective Are Antibullying Programs
  One of the most commonplace programs put into schools to combat bullying, are the aptly named anti-bullying programs, where teachers are trained to recognize bullying, as well as policies and practices regarding both cyber and physical bullying. We also look at the general response of "anti-bullying" where a school responds affirmatively if there are any anti-bullying programs put into place. 

```{r fig.height=7, fig.width=8}
schoolgraphdata1 <-  
  schooldata %>%
  group_by(discBullying, discCyber) %>%
  summarize(meanRate = mean(bullyingRate))

dummyVerts <- data.frame(discCyber = c(T, F, T, F), discBullying = c(T, T, F, F), Z = schoolgraphdata1$meanRate)

sgraph1 <-
  schooldata %>%
  ggplot(aes(x = bullyingRate)) +
  geom_density(aes(x = bullyingRate, fill = recogBullying, alpha = 0.05)) +
  facet_grid(rows = vars(discBullying), cols = vars(discCyber)) +
  geom_vline(data = dummyVerts, aes(xintercept = Z))

sgraph1 + 
  labs(x = "Trained on Combating Cyberbullying", 
       y = "Trained on Combating Bullying", 
       title = "Bullying Rates With Antibullying Programs Put Into Place") + 
  theme(axis.title.x = element_text(vjust = 205),
        axis.title.y = element_text(angle = 270, vjust = 207))
```

#### Bullying Rates for Various Combinations of Anti-Bullying Programs

```{r}
sgraph2 <-
  schooldata %>%
  ggplot(aes(x = bullyingRate, y = recogBullying, color = factor(antiBullying))) +

sgraph2 +
  geom_boxplot(lwd = 0.3, color = "black")
  geom_jitter(alpha = .15) +
  facet_grid(discBullying ~ discCyber) +
  theme(axis.text.x = element_text(vjust = 1))
```


```{r}
orderedLogRegModel <- polr(as.factor(bullyingRate) ~ recogBullying + antiBullying + discCyber + discBullying, data = schooldata, Hess = T)

coefTable <- coef(summary(orderedLogRegModel))
#technically only true at infinite df, but decent approximation at 2100 obs
pVal <- pnorm(abs(coefTable[, "t value"]), lower.tail = FALSE) * 2


coefTable <- cbind(coefTable, "p value" = pVal)
ci <- confint(orderedLogRegModel)

#printing out confidence intervals and the coefficient table
ci
coefTable
```

#### Breakdown of the Effectiveness of Anti-Bullying Programs
  After running an ordered logistic regression model, we can see that none of these p values for our predictors are particularly significant, suggesting that training school staff in anti-bullying programs, recognizing bullying, and training them to learn discipline policies for both bullying and cyberbullying are all ultimately ineffective, and these policies don't create a significant impact on bullying rates.

  Therefore, if all of these commonplace school anti-bullying programs are ineffective, what programs can schools put into place to create a significant drop in bullying rates? A good place to start looking is seeing what schools feel limit them from helping students out on the mental health spectrum.

  Sidenote: All of the differences between our levels for bullyingRates are significant, especially for the extremes, 1 and 5, which is reassuring.

### Which limitations are most common to schools?
```{r}
limitationsLong <- pivot_longer(limitations, everything(), names_to = "limType")

limitationsLong %>%
  group_by(limType, value) %>%
  summarize(valCount = n()) %>%
  ggplot(aes(x = limType, y = valCount)) + 
  geom_col(aes(x = limType, y = valCount, fill = as.character(value))) +
  scale_fill_manual(values = c("tomato", "yellow2", "green2"))
```

```{r}
limBully = data.table(limitations, schooldata$bullyingRate)
limBully <-
  limBully %>%
  rename(bullyingRate = V2)

limitationsLong2 <- pivot_longer(limBully, cols = c("comm", "funding", "legal", "MHProfAccess", "parental", "paymentPol", "stigma"), names_to = "limType") %>%
  transmute(limType = limType, limScore = value, bullyingRate = bullyingRate) 

limitationsLong3 <-
  limitationsLong2 %>%
  group_by(limType, limScore, bullyingRate) %>%
  summarize(bullyingRateCount = n())
```

```{r}
limitationsLong2 %>%  
  ggplot() +
  aes(x = limScore, fill = limType) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = sevenColorPalette)
```

#### Breakdown of What Do Schools Feel They Need

  Although, we might say some combinations like Funding being a very common highly limiting factor jump out to us immediately, we should confirm it, as well as any others are statistically different from each other. We plan on taking two different tests for significance, one within limitation scores and one within limitation types. 

  Taking a test between limitation types at a specified limitation score should tell us what, if anything is significantly percieved to be either in drastic need, or not particularly limiting in the case of limScore = 1. For the test between limitation scores for a certain limitation type should tell us how schools feel about that specific limitation, and how most schools consider it, whether to be a non-issue or of critical need.

  While taking these tests, we make the assumption that if all limitations were of equal need, and thus controlled purely by a random, normal distribution, each limitation type would be equally distributed across each limitation score. Therefore, we assign the null distribution to be equal to the average count for each limitation type across each specific limitation score.

#### Straight Counts of Occurences of Bullying Rates at Various Levels of Specific Limitations
```{r}
limitationsLong3 %>%  
  ggplot() +
  aes(x = limType, fill = as.character(bullyingRate), y = bullyingRateCount) +
  geom_bar(position = "stack", stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +
  facet_wrap( ~ limScore) +
  scale_fill_manual(values = fiveColorPalette)
```

#### Straight Counts of Occurences of Bullying Rates at Various Levels of Specific Limitations
```{r}
temp <-
  limitationsLong3 %>%
  group_by(limType, limScore) %>%
  summarize(totCount = sum(bullyingRateCount))

limitationsLong3 %>%
  left_join(temp) %>%
  mutate(propRate = bullyingRateCount/totCount) %>%
  ggplot() +
  aes(x = limType, fill = as.character(bullyingRate), y = propRate) +
  geom_bar(position = "stack", stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) +
  facet_wrap( ~ limScore) +
  scale_fill_manual(values = fiveColorPalette)
```


```{r}
schooldata %>%
  ggplot() +
  aes(x = discBullying, fill = as.character(bullyingRate)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("red", "yellow", "green", "blue", "purple"))
```

```{r}
schooldataLong <- pivotLonger
```



